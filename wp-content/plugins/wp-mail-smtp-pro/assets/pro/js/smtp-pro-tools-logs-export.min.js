"use strict";var WPMailSmtpEmailLogsExport=window.WPMailSmtpEmailLogsExport||function(t,o){var i={$form:o("#wp-mail-smtp-tools-export-email-logs"),$type:o("#wp-mail-smtp-tools-export-email-logs-export-type input"),$dateFlatpickr:o("#wp-mail-smtp-tools-export-email-logs-date-flatpickr"),$submitButton:o("#wp-mail-smtp-tools-export-email-logs-submit"),$cancelButton:o("#wp-mail-smtp-tools-export-email-logs-cancel"),$processMsg:o("#wp-mail-smtp-tools-export-email-logs-process-msg")},a=wp_mail_smtp_tools_export_email_logs.i18n,s={},n={init:function(){o(n.ready)},ready:function(){s.processing=!1,n.initDateRange(),n.initSubmit(),n.events(),"1"===wp_mail_smtp.is_network_admin&&n.initNetworkAdmin()},events:function(){o(t).on("csv_file_error",function(t,e){n.clearSubmitMsg(),n.addSubmitMsg(e,"error")}),i.$type.on("change",n.filterExportFieldsByType).filter(":checked").trigger("change")},exportAjaxStep:function(i,t){i=i||1,s.processing&&(t=n.getAjaxPostData(i,t),o.post(wp_mail_smtp.ajax_url,t).done(function(t){if(!(t.success&&t.data.total_steps>i)){n.clearSubmitMsg();var e="";return(clearTimeout(s.timerId),t.success)?0===t.data.count?(n.addSubmitMsg(a.prc_2_no_email_logs),void n.displaySubmitSpinner(!1)):(e=0<t.data.notices.length?a.prc_3_partially:a.prc_3_done,e+="<br>"+a.prc_3_download+', <a href="#" class="wp-mail-smtp-download-link">'+a.prc_3_click_here+"</a>.",n.addSubmitMsg(e,"info"),o.each(t.data.notices,function(t,e){n.addSubmitMsg(e.message,e.type)}),n.displaySubmitSpinner(!1),void n.triggerDownload(t.data.request_id)):(n.addSubmitMsg(t.data.error,"error"),void n.displaySubmitSpinner(!1))}n.exportAjaxStep(++i,t.data.request_id)}).fail(function(t,e,i){clearTimeout(s.timerId),n.addSubmitMsg(a.error_prefix+":<br>"+i,"error"),n.displaySubmitSpinner(!1)}))},getAjaxPostData:function(t,e){t=1===t?i.$form.serialize():{action:"wp_mail_smtp_tools_export_email_logs",nonce:wp_mail_smtp_tools_export_email_logs.nonce,request_id:e,step:t};return t},initSubmit:function(){i.$submitButton.on("click",function(t){t.preventDefault(),o(this).hasClass("wp-mail-smtp-btn-spinner-on")||(i.$submitButton.trigger("blur"),n.displaySubmitSpinner(!0),n.clearSubmitMsg(),s.timerId=setTimeout(function(){n.addSubmitMsg(a.prc_1_filtering+"<br>"+a.prc_1_please_wait,"info")},3e3),n.exportAjaxStep(1))}),i.$cancelButton.on("click",function(t){t.preventDefault(),i.$cancelButton.trigger("blur"),n.clearSubmitMsg(),n.displaySubmitSpinner(!1)})},initDateRange:function(){var t=wp_mail_smtp_tools_export_email_logs.lang_code,e={rangeSeparator:" - "};"undefined"!==flatpickr&&Object.prototype.hasOwnProperty.call(flatpickr,"l10ns")&&Object.prototype.hasOwnProperty.call(flatpickr.l10ns,t)&&((e=flatpickr.l10ns[t]).rangeSeparator=" - "),i.$dateFlatpickr.flatpickr({altInput:!0,altFormat:"M j, Y",dateFormat:"Y-m-d",locale:e,mode:"range"})},displaySubmitSpinner:function(t){t?(i.$submitButton.addClass("wp-mail-smtp-btn-spinner-on"),i.$cancelButton.removeClass("hidden"),s.processing=!0):(i.$submitButton.removeClass("wp-mail-smtp-btn-spinner-on"),i.$cancelButton.addClass("hidden"),s.processing=!1)},addSubmitMsg:function(t,e){e=e||"info",s.processing&&0!==t.length&&(Array.isArray(t)&&(t=t.join("<br>")),0<i.$processMsg.find(".notice-"+e).length?i.$processMsg.find(".notice-"+e+" p").append("<br>"+t):(e=o("<div>").addClass("notice-inline notice-"+e),t=o("<p>").html(t),e.append(t),i.$processMsg.append(e)),i.$processMsg.show())},clearSubmitMsg:function(){i.$processMsg.html("").hide()},triggerDownload:function(t){var e=wp_mail_smtp_tools_export_email_logs.export_page;e+="&action=wp_mail_smtp_tools_export_download_result",e+="&nonce="+wp_mail_smtp_tools_export_email_logs.nonce,e+="&request_id="+t,i.$form.find("iframe").remove(),i.$form.append('<iframe src="'+e+'"></iframe>'),i.$processMsg.find(".wp-mail-smtp-download-link").attr("href",e)},filterExportFieldsByType:function(){var t=o(this).val(),e=o("#wp-mail-smtp-tools-export-email-logs-common-fields"),i=o("#wp-mail-smtp-tools-export-email-logs-additional-info");"eml"===t?(e.hide(),i.hide()):(e.show(),i.show())},initNetworkAdmin:function(){var t=o(".wp-mail-smtp-network-admin-site-selector");t.on("change",function(){o(this).closest("form").submit()}),t.select2({dropdownCssClass:"wp-mail-smtp-select2-dropdown",cacheDataSource:{},dataAdapter:o.fn.select2.amd.require("select2/data/cacheableAjax"),ajax:{url:wp_mail_smtp.ajax_url+"?action=wp_mail_smtp_pro_get_sites_ajax&nonce="+wp_mail_smtp.nonce,dataType:"json"}})}};return n}(document,(window,jQuery));WPMailSmtpEmailLogsExport.init();